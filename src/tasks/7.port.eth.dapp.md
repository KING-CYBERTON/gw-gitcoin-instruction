# 7. Port an Existing Ethereum dApp to Polyjuice

In this tutorial you will learn how to port an existing browser Ethereum application to run on Nervos' EVM compatible [Layer 2](../conceptual-explainers/structure.md#layer-1--layer-2).

MetaMask is the primary method of interacting with dApps on Nervos. The over user experience will be very similar to existing Ethereum. The one big difference is that the MetaMask confirmation dialog will ask them to sign a hex string instead of displaying transaction. This is normal behavior when using MetaMask on Nervos since MetaMask is currently not capable of deciphering a Godwoken transaction.

The eventual goal of [Polyjuice](../conceptual-explainers/frameworks.md#polyjuice) is 100% compatibility with existing EVM smart contracts. However, this goal is still being worked on, and there will always be a few differences in the setup of the development environment and the tooling and frameworks that are used.

## Task Instructions

> Note: Before starting the tasks, it is recommended that you review the [Task Submission](#task-submission) section so you know what materials you will need to provide to judges to review your task submission.

In this task, you will need to port over an existing Ethereum dApp to Nervos' Layer 2. Our examples will use the Simple Storage smart contract, but your submission must be significantly different. Using the Simple Storage smart contract is allowed, but only the end result of your dApp is significant different than the example. If it your application is too similar to the example, it will be rejected by the judges. Our general suggestion is that you take an existing Ethereum dApp that you are already familiar with, then make the changes required to port it to Nervos.

In this guide we assume you have application that is using **Web3.js**. Instructions for Ethers.js can be found in ["Additional Tutorials and Code Examples"](#additional-tutorials-and-code-examples).

> Important: The example in this task uses the Simple Storage smart contract, but you cannot clone this code for your task. **In order to get credit for this task you must use a different project.**

### Prerequisites

Your MetaMask wallet should be installed and configured with the same Ethereum accounts from the previous tasks. Your MetaMask Ethereum account should still be funded on Layer 2 from the previous tasks.

### Setup the Godwoken Testnet Network in MetaMask

Your MetaMask wallet will need to be configured to communicate with the Godwoken Layer 2 network. To do this, you will need to configure a new custom RPC. From the network selection dropdown, select "Custom RPC".

<img src="../images/metamask-network-menu.png" alt="MetaMask Network Menu" style="height: 300px; border: 1px solid #eeeeee" />

From there you will be presented with a form to specify the network settings.

<img src="../images/metamask-networks.png" alt="MetaMask Add Network" style="height: 300px; border: 1px solid #eeeeee" />

Enter the following details.

```txt
Network Name: Godwoken Testnet
RPC URL: http://godwoken-testnet-web3-rpc.ckbapp.dev
Chain ID: 71393
Currency Symbol: <Leave Empty>
Block Explorer URL: <Leave Empty>
```

After MetaMask is configured you may see a zero balance even after you have deposited funds into this Ethereum address on Layer 2. Don't be alarmed by this. Later on we will show you how to setup your application to call `web3.eth.getBalance` with your Ethereum address to query for your balance.

### View the Demo Application

We will walk through an simple Ethereum application that has been built to use the Simple Storage to read and write number values to Layer 2. It is built using React.js and Web3.js.

We recommend that you clone the source code and follow along with our explanations so you become familiar with the process invovled in porting an application.

> Note: Remember, the application you submit must be different from our example. This guide will walk you through the process, but you must port over a different application to submit your task.

Execute the following commands to clone the project repo:

```sh
mkdir -p ~/projects
cd ~/projects
git clone https://github.com/Kuzirashi/blockchain-workshop.git -b ethereum-simple blockchain-workshop-ethereum-simple
cd blockchain-workshop-ethereum-simple
```

Next, install the dependencies, build the smart contracts, and start the UI.

```sh
yarn
yarn build
yarn ui
```

Next, open a browser to http://localhost:3000 to view the dApp UI!

> Note: You can optionally confirm the application is working on Ethereum before you begin porting it. To do this, use the provided `yarn start:ganache` script and change network in MetaMask to `localhost:8545`.

### Install Polyjuice Dependencies

The first step is to install the required dependencies for working with Godwoken and Polyjuice. Use the following command in the main project directory to install these dependencies in `package.json` of your application.

```js
npm i @polyjuice-provider/web3 nervos-godwoken-integration
```

- `@polyjuice-provider/web3` is a custom Polyjuice web3 provider. It is required for interaction with Nervos' Layer 2 smart contracts.
- `nervos-godwoken-integration` is a tool that can generate Polyjuice address based on your Ethereum address. You might be required to use Polyjuice address if you store values mapped to addresses in your contracts.

### Configure the Web3 Provider for the Polyjuice Web3 Provider

Next, we need to configure the Polyjuice Web3 Provider that was configured. Change the web3 provider URL from the one that you currently use for Ethereum to Godwoken testnet.

For example:

```js
export const CONFIG = {
    WEB3_PROVIDER_URL: 'http://localhost:8545'
};
```

is changed to:

```js
export const CONFIG = {
    WEB3_PROVIDER_URL: 'http://godwoken-testnet-web3-rpc.ckbapp.dev'
};
```

> Note: You might not have a global config for storing provider URL. In this case just go to the place where you initialize your web3.js provider instance and change it there. Chances are you've been using Ganache or Infura so far to interact with Ethereum. If you have trouble finding the place in your code you can globally search for `localhost:8545` or `infura` string and replace it with Godwoken value.

You should also add two more entries which are specific to Godwoken to this global config. They will be helpful in the next step. They are `ROLLUP_TYPE_HASH` and `ETH_ACCOUNT_LOCK_CODE_HASH`. They are required for creating Polyjuice provider. These values are constant for Godwoken testnet deployment and you can acquire them from [jjyr/godwoken-testnet repository](https://github.com/jjyr/godwoken-testnet). This is how your config should look in the end:

```js
export const CONFIG = {
    WEB3_PROVIDER_URL: 'http://godwoken-testnet-web3-rpc.ckbapp.dev',
    ROLLUP_TYPE_HASH: '0x9b260161e003972c0b699939bc164cfdcfce7fd40eb9135835008dd7e09d3dae',
    ETH_ACCOUNT_LOCK_CODE_HASH: '0xfcf093a5f1df4037cea259d49df005e0e7258b4f63e67233eda5b376b7fd2290'
};
```

> Note: We tend to use Nervos' Layer 2, Godwoken and Polyjuice names interchangeably. Don't worry though - at the high level you can think of them as the same thing.

> Note: If you're using provided demo application the config is located in `src/config.ts`.

It's time to use these constant values. In the place where you've previously created instance of your web3.js change it from:

```js
import Web3 from 'web3';

// ...

// it can be this or something similar
const web3 = new Web3(window.ethereum);
```

to:

```js
import Web3 from 'web3';

// Make sure to import the provider first!
import { PolyjuiceHttpProvider } from '@polyjuice-provider/web3';

// ...and config
import { CONFIG } from '../config';

// ...

const godwokenRpcUrl = CONFIG.WEB3_PROVIDER_URL;
const providerConfig = {
    rollupTypeHash: CONFIG.ROLLUP_TYPE_HASH,
    ethAccountLockCodeHash: CONFIG.ETH_ACCOUNT_LOCK_CODE_HASH,
    web3Url: godwokenRpcUrl
};

const provider = new PolyjuiceHttpProvider(godwokenRpcUrl, providerConfig);
const web3 = new Web3(provider);
```

The most important step is done! It's possible that your application will already start working just fine on Nervos' Layer 2!

There are, however, more steps to make sure it's stable and compatible. Check out the next steps below.

### Change Gas Price to Zero

In all places where you send transactions you need to set the gas price to zero. This is the only value supported by Godwoken currently.

You can create a constant value:

```js
const DEFAULT_SEND_OPTIONS = {
    gas: 6000000,
    gasPrice: '0'
};
```

And use it in all places where you send transactions. Eg. if you had:

```js
this.contract.methods.set(value).send({
    from: fromAddress
});
```

Then change it to:

```js
this.contract.methods.set(value).send({
    ...DEFAULT_SEND_OPTIONS,
    from: fromAddress
});
```

If you deploy a smart contract you need to additionally set "to" parameter to an empty address. For example:

```js
this.contract
    .deploy({
        data: SimpleStorageJSON.bytecode,
        arguments: []
    })
    .send({
        ...DEFAULT_SEND_OPTIONS,
        from: fromAddress,
        to: '0x0000000000000000000000000000000000000000'
    })
```

Also, the return value of the above code will be a Promise object resolving to transaction details. To get the deployed contract address you need to get `contractAddress` property of this transaction. This is example how you would do it:

```js
async deploy(fromAddress: string) {
    const deployTx = await (this.contract
        .deploy({
            data: SimpleStorageJSON.bytecode,
            arguments: []
        })
        .send({
            ...DEFAULT_SEND_OPTIONS,
            from: fromAddress,
            to: '0x0000000000000000000000000000000000000000'
        } as any) as any);

    this.useDeployed(deployTx.contractAddress);

    return deployTx.transactionHash;
}
```

> Note: In provided demo application you should change it in `src/lib/contracts/SimpleStorageWrapper.ts` which acts as an abstraction layer over direct smart contract calls.

### Display Polyjuice Address in Your Application

Because every Ethereum address becomes Polyjuice address on Nervos' Layer 2 chain you might find it useful to have tool to convert Ethereum address to Polyjuice in your JavaScript code. Therefore if you have a place where you would like to use just do the following:

```js
import { AddressTranslator } from 'nervos-godwoken-integration';

// ...

const addressTranslator = new AddressTranslator();
const polyjuiceAddress = addressTranslator.ethAddressToGodwokenShortAddress(ethereumAddress);
```

### Simple Storage Application Ported to Godwoken

If you want to see how the final ported application should look like go to the following repository: [Kuzirashi/blockchain-workshop (branch: godwoken-simple)](https://github.com/Kuzirashi/blockchain-workshop/tree/godwoken-simple).

Clone it and start web user interface server to play around with it:

```sh
git clone https://github.com/Kuzirashi/blockchain-workshop.git -b godwoken-simple blockchain-workshop-godwoken-simple
cd blockchain-workshop-godwoken-simple
yarn && yarn build && yarn ui
```

Go to http://localhost:3000 where you can test it out!

<img src="../images/ported-confirm-deploy-sign.png" height="400" />

## Task Submission

To complete the tasks, you will need to submit the following materials for review by the judges:

1. Link to the GitHub repository with your ported application **different from our Simple Storage application** example. Please use a different smart contract or multiple smart contracts.
2. A screenshot or video of your ported application.
3. If you deployed any smart contracts as part of this tutorial you can also provide: transaction hash of the deployment transaction, deployed contract address and ABI of the deployed smart contract.

## Additional Tutorials and Code Examples

### Web3.js

[Complete instructions how to migrate your dapp if you're using web3.js.](https://github.com/nervosnetwork/polyjuice-provider/blob/main/packages/ethers/README.md)

### Ethers.js

[Complete instructions how to migrate your dapp if you're using ethers.js.](https://github.com/nervosnetwork/polyjuice-provider/blob/main/packages/web3/README.md)

### Caveats

[In this document](https://github.com/nervosnetwork/godwoken-polyjuice/blob/main/docs/EVM-compatible.md) you can find all the things different than Ethereum and potentially causing problems for you.

If you need to use `ecrecover` you will have to modify your smart-contracts to do an internal system call using assembly. You can find documentation for that syscall [here](https://github.com/nervosnetwork/godwoken-polyjuice/blob/main/docs/Addition-Features.md), there is an [example code](https://github.com/RetricSu/godwoken-polyjuice-compatibility-examples#compatibility).

### More Examples

If you need more examples of working Nervos' Layer 2 applications you can take a look at the following repositories:

1. [Head or Tail bet application](https://github.com/Kuzirashi/blockchain-workshop/tree/godwoken)
2. [godwoken-polyjuice-compatibility-examples repository](https://github.com/RetricSu/godwoken-polyjuice-compatibility-examples)
