# 7. Port an Existing Ethereum dApp to Polyjuice

In this tutorial you will learn how to port an existing browser Ethereum application to Nervos' Layer 2.

**Important!**

You can find here example application using Simple Storage smart contract, but **for receiving the prize you need to use a different smart contract than the one that we have provided. Be creative.** Our suggestion is to take an existing Ethereum application other than our example and port it. Submissions looking like 1:1 clones of our Simple Storage example won't be taken seriously. It doesn't mean you can't use it as a framework to build something different - please do if it makes your life easier.

<hr/>

## Requirements

Before starting, you will need to setup your development environment. For information about setup and requirements please [review this article](../tasks-setup-and-requirements/tasks-setup-and-requirements.md).


## Task Instructions

> Note: Before starting the tasks, it is recommended that you review the [Task Submission](#task-submission) section so you know what materials you will need to provide to judges to review your task submission.

User interface and interaction with the smart-contracts will be done through MetaMask so the overall user experience will be quite similar to Ethereum apps. **The main difference is that MetaMask instead of showing send transaction dialog to user will ask him to sign a string.** Don't worry. This is correct behavior in Godwoken. This signed string is a signed Godwoken transaction.

In this guide we assume you have application that is using **web3.js**. Ethers.js guide can be found in ["Additional tutorials and code examples"](#additional-tutorials-and-code-examples).

### Install MetaMask and setup Godwoken Testnet network

Install MetaMask, create account, deposit CKB on Layer 2 to your Ethereum address and set the network in your MetaMask to Godwoken network. If you don't know how to do that look at the previous tasks where all of this has been demonstrated. These are the parameters for adding Godwoken testnet network in MetaMask:

```
Network Name: Godwoken Testnet
RPC URL: http://godwoken-testnet-web3-rpc.ckbapp.dev
Chain ID: 71393
```

Don't worry if you see zero funds in your MetaMask wallet if you have previously correctly deposited funds to your Layer 2 address on Godwoken. After you will setup your application to use the Polyjuice provider you will be able to call `web3.eth.getBalance` with your Ethereum address and if the value is higher than zero, it means you have funds on the Layer 2. If you don't, please [deposit funds to your Layer 2 account first](../component-tutorials/4.layer2.deposit.md).

### Provided demo application to port

You can use existing Ethereum application that we've put together for this tutorial to follow along. It is using Simple Storage smart contract where you can read and set the stored number value. It is built with React.js and Web3.js.

*Remember you won't be able to submit it without modifications. You need to add/change something and use a different smart contract. You can also take a different Ethereum application than our example.*

This is how you can obtain a local copy of this application to work with:

```sh
git clone https://github.com/Kuzirashi/blockchain-workshop.git -b ethereum-simple blockchain-workshop-ethereum-simple
cd blockchain-workshop-ethereum-simple
# install dependencies
yarn

# compile smart contracts
yarn build

# start UI
yarn ui
```

Go to http://localhost:3000 where you can test it out and start modifying!

> Note: you can confirm the application is working on Ethereum before you port it. You can use provided `yarn start:ganache` script and change network in MetaMask to `localhost:8545` to test it. You can also trust us and move on to porting it to Nervos' Layer 2.

### Install Polyjuice dependencies

A first step is to install required NPM packages. In `package.json` of your application add following dependencies:
```js
"@polyjuice-provider/web3": "0.0.1-rc5",
"nervos-godwoken-integration": "0.0.2",
```

- `@polyjuice-provider/web3` is a custom Polyjuice web3 provider. It is absolutely required for interaction with Nervos' Layer 2 smart contracts.
- `nervos-godwoken-integration` is a handy tool that can generate Polyjuice address based on your Ethereum address. You might be required to use Polyjuice address if you store values mapped to addresses in your contracts.

### Change Web3 provider

The second step is to use the packages you've just installed. Change the web3 provider URL from the one that you currently use for Ethereum to Godwoken testnet. For example change:
```js
export const CONFIG = {
    WEB3_PROVIDER_URL: 'http://localhost:8545'
};
```

to:
```js
export const CONFIG = {
    WEB3_PROVIDER_URL: 'http://godwoken-testnet-web3-rpc.ckbapp.dev'
};
```

> Note: You might not have a global config for storing provider URL. In this case just go to the place where you initialize your web3.js provider instance and change it there. Chances are you've been using Ganache or Infura so far to interact with Ethereum. If you have trouble finding the place in your code you can globally search for `localhost:8545` or `infura` string and replace it with Godwoken value.

You should also add two more entries which are specific to Godwoken to this global config. They will be helpful in the next step. They are `ROLLUP_TYPE_HASH` and `ETH_ACCOUNT_LOCK_CODE_HASH`. They are required for creating Polyjuice provider. These values are constant for Godwoken testnet deployment and you can acquire them from [jjyr/godwoken-testnet repository](https://github.com/jjyr/godwoken-testnet). This is how your config should look in the end:
```js
export const CONFIG = {
    WEB3_PROVIDER_URL: 'http://godwoken-testnet-web3-rpc.ckbapp.dev',
    ROLLUP_TYPE_HASH: '0x9b260161e003972c0b699939bc164cfdcfce7fd40eb9135835008dd7e09d3dae',
    ETH_ACCOUNT_LOCK_CODE_HASH: '0xfcf093a5f1df4037cea259d49df005e0e7258b4f63e67233eda5b376b7fd2290'
};
```
> Note: We tend to use Nervos' Layer 2, Godwoken and Polyjuice names interchangeably. Don't worry though - at the high level you can think of them as the same thing.

> Note: If you're using provided demo application the config is located in `src/config.ts`.

It's time to use these constant values. In the place where you've previously created instance of your web3.js change it from:

```js
import Web3 from 'web3';

// ...

// it can be this or something similar
const web3 = new Web3(window.ethereum);
```

to:

```js
import Web3 from 'web3';

// Make sure to import the provider first!
import { PolyjuiceHttpProvider } from '@polyjuice-provider/web3';

// ...and config
import { CONFIG } from '../config';

// ...

const godwokenRpcUrl = CONFIG.WEB3_PROVIDER_URL;
const providerConfig = {
    rollupTypeHash: CONFIG.ROLLUP_TYPE_HASH,
    ethAccountLockCodeHash: CONFIG.ETH_ACCOUNT_LOCK_CODE_HASH,
    web3Url: godwokenRpcUrl
};

const provider = new PolyjuiceHttpProvider(godwokenRpcUrl, providerConfig);
const web3 = new Web3(provider);
```

The most important step is done! It's possible that your application will already start working just fine on Nervos' Layer 2!

There are, however, more steps to make sure it's stable and compatible. Check out the next steps below.

### Change gas price to zero

In all places where you send transactions you need to set the gas price to zero. This is the only value supported by Godwoken currently.

You can create a constant value:
```js
const DEFAULT_SEND_OPTIONS = {
    gas: 6000000,
    gasPrice: '0'
};
```

And use it in all places where you send transactions. Eg. if you had:
```js
this.contract.methods.set(value).send({
    from: fromAddress
});
```

Then change it to:
```js
this.contract.methods.set(value).send({
    ...DEFAULT_SEND_OPTIONS,
    from: fromAddress
});
```

If you deploy a smart contract you need to additionally set "to" parameter to an empty address. For example:
```js
this.contract
    .deploy({
        data: SimpleStorageJSON.bytecode,
        arguments: []
    })
    .send({
        ...DEFAULT_SEND_OPTIONS,
        from: fromAddress,
        to: '0x0000000000000000000000000000000000000000'
    })
```

Also, the return value of the above code will be a Promise object resolving to transaction details. To get the deployed contract address you need to get `contractAddress` property of this transaction. This is example how you would do it:

```js
async deploy(fromAddress: string) {
    const deployTx = await (this.contract
        .deploy({
            data: SimpleStorageJSON.bytecode,
            arguments: []
        })
        .send({
            ...DEFAULT_SEND_OPTIONS,
            from: fromAddress,
            to: '0x0000000000000000000000000000000000000000'
        } as any) as any);

    this.useDeployed(deployTx.contractAddress);

    return deployTx.transactionHash;
}
```

> Note: In provided demo application you should change it in `src/lib/contracts/SimpleStorageWrapper.ts` which acts as an abstraction layer over direct smart contract calls.

### Display Polyjuice address in your application

Because every Ethereum address becomes Polyjuice address on Nervos' Layer 2 chain you might find it useful to have tool to convert Ethereum address to Polyjuice in your JavaScript code. Therefore if you have a place where you would like to use just do the following:

```js
import { AddressTranslator } from 'nervos-godwoken-integration';

// ...

const addressTranslator = new AddressTranslator();
const polyjuiceAddress = addressTranslator.ethAddressToGodwokenShortAddress(ethereumAddress);
```

### Simple Storage Application ported to Godwoken

If you want to see how the final ported application should look like go to the following repository: [Kuzirashi/blockchain-workshop (branch: godwoken-simple)](https://github.com/Kuzirashi/blockchain-workshop/tree/godwoken-simple).

Clone it and start web user interface server to play around with it:
```
git clone https://github.com/Kuzirashi/blockchain-workshop.git -b godwoken-simple blockchain-workshop-godwoken-simple
cd blockchain-workshop-godwoken-simple
yarn && yarn build && yarn ui
```

Go to http://localhost:3000 where you can test it out!

<img src="../images/ported-confirm-deploy-sign.png" height="400" />

## Task Submission

To complete the tasks, you will need to submit the following materials for review by the judges:

1. Link to the GitHub repository with your ported application **different from our Simple Storage application** example. Please use a different smart contract or multiple smart contracts.
2. A screenshot or video of your ported application.
3. If you deployed any smart contracts as part of this tutorial you can also provide: transaction hash of the deployment transaction, deployed contract address and ABI of the deployed smart contract.

## Additional tutorials and code examples

### Web3.js

[Complete instructions how to migrate your dapp if you're using web3.js.](https://github.com/nervosnetwork/polyjuice-provider/blob/main/packages/ethers/README.md)

### Ethers.js

[Complete instructions how to migrate your dapp if you're using ethers.js.](https://github.com/nervosnetwork/polyjuice-provider/blob/main/packages/web3/README.md)

### Caveats

[In this document](https://github.com/nervosnetwork/godwoken-polyjuice/blob/main/docs/EVM-compatible.md) you can find all the things different than Ethereum and potentially causing problems for you.

If you need to use `ecrecover` you will have to modify your smart-contracts to do an internal system call using assembly. You can find documentation for that syscall [here](https://github.com/nervosnetwork/godwoken-polyjuice/blob/main/docs/Addition-Features.md), there is an [example code](https://github.com/RetricSu/godwoken-polyjuice-compatibility-examples#compatibility).

### More examples

If you need more examples of working Nervos' Layer 2 applications you can take a look at the following repositories:

1. [Head or Tail bet application](https://github.com/Kuzirashi/blockchain-workshop/tree/godwoken)
2. [godwoken-polyjuice-compatibility-examples repository](https://github.com/RetricSu/godwoken-polyjuice-compatibility-examples)